webpackJsonp([48],{gtLT:function(t,e,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=o("mOK0"),s=o.n(a),n=o("W2fy"),r=o("+mJe"),i=o("F4Rs"),l=o.n(i),c=(o("OVNN"),o("vHhr")),p=(o("E4LH"),o("dZ8K")),m=o("z0wn"),u={Title:"",Metric:"",Tag:"",Operator:"",Value:"",Author:"",Timeout:40,BeginNotice:!0,SuccNotice:!0,FailNotice:!0,NoticeUser:[],NoticeTeam:"",Isvalid:0,Operation:[{Title:"",User:"root",Hosts:"",Command:"",Step:1,Expand:!1}],OperationDel:[]},d={name:"autofill_access",components:{MDinput:r.a,Multiselect:l.a,Sticky:c.a,PanelTitle:n.a},data:function(){var t=function(t,e,o){if(!e)return o(new Error("该项不能为空"));/^\d+(\.\d+)?$/.test(e)||/^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/.test(e)?o():o(new Error("请输入数字值"))};return{fill_id:this.$route.params.id,optype:this.$route.params.id?"published":"draft",postForm:s()({},u),fetchSuccess:!0,loading:!1,teamLIstOptions:[],userLIstOptions:[],expands:[],steps:1,rules:{Title:[{required:!0,message:"自愈方案名称不能为空",trigger:"blur"}],Metric:[{required:!0,message:"Metric不能为空",trigger:"blur"}],Operator:[{required:!0,message:"比较运算符必选",trigger:"change"}],Value:[{validator:t,trigger:"blur",required:!0}],Timeout:[{validator:t,trigger:"blur",required:!0}]}}},computed:{operationLength:function(){return this.postForm.Operation.length}},created:function(){this.fill_id?this.fetchData(this.fill_id):this.postForm=s()({},u),0===this.$store.state.user.userList.length&&this.$store.dispatch("GetUserList"),0===this.$store.state.user.teamList.length&&this.$store.dispatch("GetTeamList")},methods:{fetchData:function(t){var e=this;Object(m.c)(t).then(function(t){e.postForm=t.data,e.postForm.BeginNotice=!!e.postForm.BeginNotice,e.postForm.SuccNotice=!!e.postForm.SuccNotice,e.postForm.FailNotice=!!e.postForm.FailNotice,e.postForm.NoticeUser=e.postForm.NoticeUser?e.postForm.NoticeUser.split(","):[],e.postForm.OperationDel=[],e.steps=e.postForm.Operation.length}).catch(function(t){e.fetchSuccess=!1,console.log(t)})},addOperation:function(){this.postForm.Operation.push({Title:"",User:"root",Hosts:"",Command:"",Step:this.steps+1,Expand:!1}),this.steps++},delOperation:function(t){var e=this;this.$confirm("是否删除该步骤?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){e.operationLength<=1?e.$message({message:"至少需要一个步骤",type:"error"}):(e.postForm.Operation.splice(e.postForm.Operation.indexOf(t),1),""!=t.Id&&e.postForm.OperationDel.push(t.Id))}).catch(function(){})},handleRowExpansion:function(t,e){this.expands=[],this.postForm.Operation.forEach(function(e){e.Step!=t.Step&&(e.Expand=!1)}),t.Expand=!!e||!t.Expand,t.Expand&&this.expands.push(t.Step)},handleRowMove:function(t,e){if("up"==e){if(0==(a=this.postForm.Operation.indexOf(t)))return;var o=this.postForm.Operation[a-1];p.default.set(this.postForm.Operation,a-1,this.postForm.Operation[a]),p.default.set(this.postForm.Operation,a,o)}else{var a;if((a=this.postForm.Operation.indexOf(t))==this.operationLength-1)return;o=this.postForm.Operation[a+1];p.default.set(this.postForm.Operation,a+1,this.postForm.Operation[a]),p.default.set(this.postForm.Operation,a,o)}},submitForm:function(){var t=this;console.log(this.postForm),this.$refs.postForm.validate(function(e){if(!e)return!1;var o=t.checkOperation();""==o?(t.loading=!0,t.postForm.BeginNotice=t.postForm.BeginNotice?1:0,t.postForm.SuccNotice=t.postForm.SuccNotice?1:0,t.postForm.FailNotice=t.postForm.FailNotice?1:0,t.postForm.NoticeUser=t.postForm.NoticeUser.toString(),t.postForm.Timeout=parseInt(t.postForm.Timeout),t.fill_id?Object(m.e)(t.postForm).then(function(e){"OK"===e.data?(t.$notify({title:"成功",message:"修改方案成功",type:"success",duration:2e3}),t.$router.push({path:"/autofill/access/list"})):(t.loading=!1,t.$notify({title:"失败",message:e.data,type:"error",duration:2e3}))}):(t.postForm.Author=t.$store.state.user.userInfo.name,Object(m.d)(t.postForm).then(function(e){"OK"===e.data?(t.$notify({title:"成功",message:"新增方案成功",type:"success",duration:2e3}),t.$router.push({path:"/autofill/access/list"})):(t.loading=!1,t.$notify({title:"失败",message:e.data,type:"error",duration:2e3}))}))):t.$message({message:o,type:"error"})})},checkOperation:function(){for(var t=0;t<this.postForm.Operation.length;t++){var e=this.postForm.Operation[t];if(""==e.Title)return"步骤"+(t+1)+"--步骤名不能为空";if(""==e.User)return"步骤"+(t+1)+"--执行账户不能为空";if(""==e.Hosts)return"步骤"+(t+1)+"--机器列表不能为空"}return""==this.postForm.NoticeTeam&&0==this.postForm.NoticeUser.length?"至少需要一个接受组或接收人":""},getRemoteUserList:function(t){var e=this,o=[];this.$store.state.user.userList.forEach(function(t){o.push(t.name)}),""!==t?setTimeout(function(){e.userLIstOptions=o.filter(function(e){return e.toLowerCase().indexOf(t.toLowerCase())>-1})},200):this.userLIstOptions=[]},getRemoteTeamList:function(t){var e=this,o=[];this.$store.state.user.teamList.forEach(function(t){o.push(t.name)}),""!==t?setTimeout(function(){e.teamLIstOptions=o.filter(function(e){return e.toLowerCase().indexOf(t.toLowerCase())>-1})},200):this.teamLIstOptions=[]},back:function(){this.$router.go(-1)}}},f={render:function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"createPost-container"},[o("el-form",{ref:"postForm",staticClass:"form-container",attrs:{model:t.postForm,rules:t.rules}},[o("sticky",{attrs:{className:"sub-navbar "+t.optype}},[t.fetchSuccess?[o("el-dropdown",{attrs:{trigger:"click"}},[o("el-button",{attrs:{plain:""}},[t._v(t._s(t.postForm.Isvalid?"已启用":"未启用")+"\n              "),o("i",{staticClass:"el-icon-caret-bottom el-icon--right"})]),t._v(" "),o("el-dropdown-menu",{staticClass:"no-padding",attrs:{slot:"dropdown"},slot:"dropdown"},[o("el-dropdown-item",[o("el-radio-group",{staticStyle:{padding:"10px"},model:{value:t.postForm.Isvalid,callback:function(e){t.$set(t.postForm,"Isvalid",e)},expression:"postForm.Isvalid"}},[o("el-radio",{attrs:{label:1}},[t._v("启用")]),t._v(" "),o("el-radio",{attrs:{label:0}},[t._v("停用")])],1)],1)],1)],1),t._v(" "),o("el-button",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticStyle:{"margin-left":"10px"},attrs:{type:"success"},on:{click:function(e){t.submitForm()}}},[t._v("保存\n          ")]),t._v(" "),o("el-button",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{type:"warning"},on:{click:function(e){t.back()}}},[t._v("取消")])]:[o("el-tag",[t._v("发送异常错误,刷新页面,或者联系程序员")])]],2),t._v(" "),o("div",{staticClass:"createPost-main-container"},[o("el-form-item",{attrs:{prop:"Title"}},[o("MDinput",{attrs:{name:"name",required:"",maxlength:100},model:{value:t.postForm.Title,callback:function(e){t.$set(t.postForm,"Title",e)},expression:"postForm.Title"}},[t._v("\n            自愈方案名称\n          ")])],1),t._v(" "),o("div",{staticClass:"panel",staticStyle:{"margin-top":"20px"}},[o("panel-title",{attrs:{title:"自愈场景"}}),t._v(" "),o("el-row",{staticStyle:{"margin-top":"20px"}},[o("el-col",{attrs:{span:21}},[o("div",{staticClass:"postInfo-container"},[o("el-row",[o("el-col",{attrs:{span:8}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"Falcon Metric",placement:"top"}},[o("el-form-item",{attrs:{"label-width":"80px",label:"Metric",prop:"Metric"}},[o("el-input",{attrs:{placeholder:"Falcon Metric"},model:{value:t.postForm.Metric,callback:function(e){t.$set(t.postForm,"Metric",e)},expression:"postForm.Metric"}})],1)],1)],1),t._v(" "),o("el-col",{attrs:{span:8}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"Falcon Tags",placement:"top"}},[o("el-form-item",{attrs:{"label-width":"80px",label:"Tags"}},[o("el-input",{attrs:{placeholder:"Falcon Tags"},model:{value:t.postForm.Tag,callback:function(e){t.$set(t.postForm,"Tag",e)},expression:"postForm.Tag"}})],1)],1)],1),t._v(" "),o("el-col",{attrs:{span:3}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"比较运算符",placement:"top"}},[o("el-form-item",{attrs:{"label-width":"80px",label:" ",prop:"Operator"}},[o("el-select",{attrs:{size:"300"},model:{value:t.postForm.Operator,callback:function(e){t.$set(t.postForm,"Operator",e)},expression:"postForm.Operator"}},[o("el-option",{attrs:{label:">",value:">"}}),t._v(" "),o("el-option",{attrs:{label:"=",value:"="}}),t._v(" "),o("el-option",{attrs:{label:"<",value:"<"}})],1)],1)],1)],1),t._v(" "),o("el-col",{attrs:{span:5}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"Judge Value",placement:"top"}},[o("el-form-item",{attrs:{"label-width":"80px",label:"Value",prop:"Value"}},[o("el-input",{attrs:{placeholder:"Judge Value"},model:{value:t.postForm.Value,callback:function(e){t.$set(t.postForm,"Value",e)},expression:"postForm.Value"}})],1)],1)],1)],1)],1)])],1)],1),t._v(" "),o("div",{staticClass:"panel",staticStyle:{"margin-top":"20px"}},[o("panel-title",{attrs:{title:"自愈处理"}}),t._v(" "),o("el-row",{staticStyle:{margin:"20px"}},[o("el-table",{ref:"operation_table",staticStyle:{width:"100%"},attrs:{data:t.postForm.Operation,"row-key":"Step","expand-row-keys":t.expands}},[o("el-table-column",{attrs:{type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-form",{staticClass:"demo-table-expand",attrs:{"label-position":"left",inline:""}},[o("el-form-item",{attrs:{label:"机器列表:",required:""}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"要发布的机器列表，一行一个，22端口, 当前告警机器{CURRENT}",placement:"top"}},[o("el-input",{staticStyle:{width:"400px"},attrs:{type:"textarea",rows:4,placeholder:"192.168.0.1\n192.168.0.2"},model:{value:e.row.Hosts,callback:function(o){t.$set(e.row,"Hosts",o)},expression:"scope.row.Hosts"}})],1)],1),t._v(" "),o("el-form-item",{attrs:{label:"脚本命令:"}},[o("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"一行一条,相关参数{HOSTS}",placement:"top"}},[o("el-input",{staticStyle:{width:"400px"},attrs:{type:"textarea",rows:4},model:{value:e.row.Command,callback:function(o){t.$set(e.row,"Command",o)},expression:"scope.row.Command"}})],1)],1)],1)]}}])}),t._v(" "),o("el-table-column",{attrs:{label:"执行顺序",align:"center",width:"100px"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("div",[t._v(t._s(e.$index+1))])]}}])}),t._v(" "),o("el-table-column",{attrs:{label:"步骤名","label-class-name":"reqlabel",align:"center"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{attrs:{placeholder:""},on:{focus:function(o){t.handleRowExpansion(e.row,!0)}},model:{value:e.row.Title,callback:function(o){t.$set(e.row,"Title",o)},expression:"scope.row.Title"}})]}}])}),t._v(" "),o("el-table-column",{attrs:{align:"center",label:"执行账户","label-class-name":"reqlabel"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-input",{attrs:{placeholder:"Falcon Metric"},model:{value:e.row.User,callback:function(o){t.$set(e.row,"User",o)},expression:"scope.row.User"}})]}}])}),t._v(" "),o("el-table-column",{attrs:{align:"center",label:"所有操作"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-button",{staticStyle:{color:"#409EFF","font-size":"18px"},attrs:{type:"text",icon:"el-icon-edit-outline"},on:{click:function(o){t.handleRowExpansion(e.row)}}}),t._v(" "),o("el-button",{staticStyle:{color:"#409EFF","font-size":"18px"},attrs:{type:"text",icon:"el-icon-sort-up"},on:{click:function(o){t.handleRowMove(e.row,"up")}}}),t._v(" "),o("el-button",{staticStyle:{color:"#409EFF","font-size":"18px"},attrs:{type:"text",icon:"el-icon-sort-down"},on:{click:function(o){t.handleRowMove(e.row,"down")}}}),t._v(" "),o("el-button",{staticStyle:{color:"red","font-size":"18px"},attrs:{type:"text",icon:"el-icon-close"},on:{click:function(o){t.delOperation(e.row)}}})]}}])})],1),t._v(" "),o("h5",{staticStyle:{"margin-bottom":"5px","font-size":"15px"}},[o("el-button",{staticClass:"fa fa-plus",staticStyle:{color:"#409EFF","font-size":"16px","font-weight":"bold"},attrs:{type:"text"},on:{click:t.addOperation}},[t._v("    添加步骤")])],1)],1)],1),t._v(" "),o("div",{staticClass:"panel",staticStyle:{"margin-top":"20px"}},[o("panel-title",{attrs:{title:"自愈通知"}}),t._v(" "),o("el-row",{staticStyle:{"margin-top":"20px"}},[o("div",{staticClass:"postInfo-container"},[o("el-row",[o("el-col",{attrs:{span:21}},[o("el-form-item",{attrs:{"label-width":"100px",label:"超时",prop:"Timeout"}},[o("el-col",{attrs:{span:3}},[o("el-input",{model:{value:t.postForm.Timeout,callback:function(e){t.$set(t.postForm,"Timeout",e)},expression:"postForm.Timeout"}},[o("template",{staticStyle:{padding:"0 5px"},slot:"append"},[t._v("分")])],2)],1),t._v(" "),o("el-col",{attrs:{span:4}},[o("span",{staticStyle:{"padding-left":"10px"}},[t._v("以上按失败处理")])])],1)],1),t._v(" "),o("el-col",{attrs:{span:21}},[o("el-form-item",{attrs:{"label-width":"100px",label:"通知方式"}},[o("el-checkbox",{model:{value:t.postForm.BeginNotice,callback:function(e){t.$set(t.postForm,"BeginNotice",e)},expression:"postForm.BeginNotice"}},[t._v("开始时")]),t._v(" "),o("el-checkbox",{model:{value:t.postForm.SuccNotice,callback:function(e){t.$set(t.postForm,"SuccNotice",e)},expression:"postForm.SuccNotice"}},[t._v("成功时")]),t._v(" "),o("el-checkbox",{model:{value:t.postForm.FailNotice,callback:function(e){t.$set(t.postForm,"FailNotice",e)},expression:"postForm.FailNotice"}},[t._v("失败时")])],1)],1),t._v(" "),o("el-col",{attrs:{span:21}},[o("el-form-item",{attrs:{"label-width":"100px",label:"通知人员"}},[o("el-col",{attrs:{span:2}},[t._v("\n                        接收组：\n                      ")]),t._v(" "),o("el-col",{attrs:{span:8}},[o("multiselect",{attrs:{options:t.teamLIstOptions,placeholder:"搜索用户组",selectLabel:"选择",deselectLabel:"删除",internalSearch:!1},on:{"search-change":t.getRemoteTeamList},model:{value:t.postForm.NoticeTeam,callback:function(e){t.$set(t.postForm,"NoticeTeam",e)},expression:"postForm.NoticeTeam"}},[o("span",{attrs:{slot:"noResult"},slot:"noResult"},[t._v("无结果")])])],1)],1)],1),t._v(" "),o("el-col",{attrs:{span:21}},[o("el-form-item",{attrs:{"label-width":"100px",label:""}},[o("el-col",{attrs:{span:2}},[t._v("\n                        接收人：\n                      ")]),t._v(" "),o("el-col",{attrs:{span:8}},[o("multiselect",{attrs:{options:t.userLIstOptions,multiple:!0,placeholder:"搜索用户",selectLabel:"选择",deselectLabel:"删除",internalSearch:!1},on:{"search-change":t.getRemoteUserList},model:{value:t.postForm.NoticeUser,callback:function(e){t.$set(t.postForm,"NoticeUser",e)},expression:"postForm.NoticeUser"}},[o("span",{attrs:{slot:"noResult"},slot:"noResult"},[t._v("无结果")])])],1)],1)],1),t._v(" "),o("el-col",{attrs:{span:21}},[o("el-form-item",{attrs:{"label-width":"100px",label:""}},[o("span",{staticStyle:{color:"#ffcc6b"}},[t._v("注：")]),o("span",{staticStyle:{color:"#ccc"}},[t._v("在UIC中管理接收组")]),o("a",{attrs:{href:"http://fe.juanpi.org/team/all",target:"_blank"}},[t._v("【快捷入口】")])])],1)],1)],1)])],1)],1)],1)],1)},staticRenderFns:[]};var h=o("kgPM")(d,f,!1,function(t){o("pjzg")},"data-v-15f442a4",null);e.default=h.exports},o8gI:function(t,e,o){(t.exports=o("xCkK")(!1)).push([t.i,'\n.title-prompt[data-v-15f442a4] {\n  position: absolute;\n  right: 0px;\n  font-size: 12px;\n  top: 10px;\n  color: #ff4949;\n}\n.createPost-container[data-v-15f442a4] {\n  position: relative;\n}\n.createPost-container .createPost-main-container[data-v-15f442a4] {\n    padding: 40px 45px 20px 50px;\n}\n.createPost-container .createPost-main-container .postInfo-container[data-v-15f442a4] {\n      position: relative;\n      margin-bottom: 10px;\n}\n.createPost-container .createPost-main-container .postInfo-container[data-v-15f442a4]:after {\n        content: "";\n        display: table;\n        clear: both;\n}\n.createPost-container .createPost-main-container .postInfo-container .postInfo-container-item[data-v-15f442a4] {\n        float: left;\n}\n.createPost-container .createPost-main-container .editor-container[data-v-15f442a4] {\n      min-height: 500px;\n      margin: 0 0 30px;\n}\n.createPost-container .createPost-main-container .editor-container .editor-upload-btn-container[data-v-15f442a4] {\n        text-align: right;\n        margin-right: 10px;\n}\n.createPost-container .createPost-main-container .editor-container .editor-upload-btn-container .editor-upload-btn[data-v-15f442a4] {\n          display: inline-block;\n}\n.createPost-container .word-counter[data-v-15f442a4] {\n    width: 40px;\n    position: absolute;\n    right: -10px;\n    top: 0px;\n}\n.demo-table-expand[data-v-15f442a4] {\n  font-size: 0;\n}\n.demo-table-expand label[data-v-15f442a4] {\n  width: 90px;\n  color: #99a9bf;\n}\n.demo-table-expand .el-form-item[data-v-15f442a4] {\n  margin-right: 0;\n  margin-bottom: 0;\n  width: 50%;\n}\n',""])},pjzg:function(t,e,o){var a=o("o8gI");"string"==typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);o("MO7y")("60ab5386",a,!0)}});